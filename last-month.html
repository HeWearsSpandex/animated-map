<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Last Month’s Leaderboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; }
    table { border-collapse: collapse; width:100%; max-width:600px; margin:auto; }
    th, td { padding:8px 12px; text-align:left; }
    th { background:#f4f4f4; }
    img.face { border-radius:50%; vertical-align:middle; }
    td.rank { font-size:inherit; }
    .logo { text-align:center; margin-bottom:20px; }
    .logo img { max-width:200px; height:auto; }
  </style>
</head>
<body>
  <div class="logo">
    <img src="img/JHB Logo.png" alt="JHB Logo">
  </div>
  <h1>Last Month’s Leaderboard</h1>
  <table id="lm-table">
    <thead>
      <tr><th>Rank</th><th>Face</th><th>Name</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const CSV_URL  = 'https://raw.githubusercontent.com/HeWearsSpandex/animated-map/main/data/actual_distances.csv';
    const IMG_PATH = 'img/';

    async function fetchData() {
      const res = await fetch(CSV_URL, { cache:'no-cache' });
      if (!res.ok) throw new Error('Could not load CSV: ' + res.status);
      const text = await res.text();
      const [hdr, ...lines] = text.trim().split(/\r?\n/);
      const keys = hdr.split(',').map(h => h.trim());
      return lines.map(line => {
        const cols = line.split(',');
        return keys.reduce((obj,k,i) => {
          obj[k] = (cols[i]||'').trim();
          return obj;
        }, {});
      });
    }

    function loadImage(src) {
      return new Promise((res, rej) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload  = () => res(img);
        img.onerror = rej;
        img.src     = src;
      });
    }

    const NAME_OVERRIDES = {
      // 'Bradley Turnstill': 'Bradley_Tunstill'
    };

    async function drawIcon(name, useHalo = true, faceSize = 64, haloThickness = useHalo ? 10 : 0) {
      const key      = NAME_OVERRIDES[name] || name;
      // preserve spaces so filenames like "Byron Claridge_cvface1.png" resolve
      const safe     = key.trim();
      const filename = `${encodeURIComponent(safe)}_cvface1.png`;
      const size     = faceSize + 2*haloThickness;
      const canvas   = document.createElement('canvas');
      canvas.width = canvas.height = size;
      const ctx = canvas.getContext('2d');

      if (useHalo) {
        ctx.fillStyle = 'gold';
        ctx.beginPath();
        ctx.arc(size/2, size/2, faceSize/2 + haloThickness, 0, 2*Math.PI);
        ctx.arc(size/2, size/2, faceSize/2, 0, 2*Math.PI);
        ctx.fill('evenodd');
      }

      let faceImg;
      try {
        faceImg = await loadImage(IMG_PATH + filename);
      } catch {
        faceImg = document.createElement('canvas');
        faceImg.width = faceImg.height = faceSize;
        const ph = faceImg.getContext('2d');
        ph.fillStyle = '#ccc';
        ph.fillRect(0,0,faceSize,faceSize);
      }

      ctx.drawImage(faceImg, haloThickness, haloThickness, faceSize, faceSize);
      return canvas.toDataURL('image/png');
    }

    async function buildLastMonthTable() {
      const data = await fetchData();

      // 1) sort by TOTAL METERS descending
      const rows = data
        .filter(r => r['TOTAL METERS'])
        .sort((a,b) => Number(b['TOTAL METERS']) - Number(a['TOTAL METERS']));

      // 2) assign competition ranks (_rank), ties share rank
      let lastMeters = null, count = 0, currentRank = 0;
      rows.forEach(r => {
        count++;
        const m = Number(r['TOTAL METERS']);
        if (m !== lastMeters) {
          currentRank = count;
          lastMeters = m;
        }
        r._rank = currentRank;
      });

      // 3) build a map of how many share each rank
      const rankCounts = rows.reduce((acc, r) => {
        acc[r._rank] = (acc[r._rank] || 0) + 1;
        return acc;
      }, {});

      // 4) render table
      const tbody = document.querySelector('#lm-table tbody');
      tbody.innerHTML = '';

      for (const row of rows) {
        const isLeader    = row._rank === 1;
        const displaySize = 64 + (isLeader ? 10 : 0);

        // prefix '=' for any tied rank; no trailing dot
        const isTie    = rankCounts[row._rank] > 1;
        const rankText = (isTie ? '=' : '') + row._rank;

        const tr = document.createElement('tr');

        // Rank cell
        const tdRank = document.createElement('td');
        tdRank.classList.add('rank');
        tdRank.textContent = rankText;
        tr.appendChild(tdRank);

        // Face cell
        const tdFace = document.createElement('td');
        const iconUrl = await drawIcon(row['NAME'], isLeader);
        const imgEl   = document.createElement('img');
        imgEl.src     = iconUrl;
        imgEl.width   = imgEl.height = displaySize;
        imgEl.classList.add('face');
        tdFace.appendChild(imgEl);
        tr.appendChild(tdFace);

        // Name cell
        const tdName = document.createElement('td');
        tdName.textContent = row['NAME'];
        tr.appendChild(tdName);

        tbody.appendChild(tr);
      }
    }

    buildLastMonthTable().catch(e => {
      console.error(e);
      document.querySelector('#lm-table tbody').innerHTML =
        '<tr><td colspan="3" style="color:red">Failed to load data.</td></tr>';
    });
  </script>
</body>
</html>

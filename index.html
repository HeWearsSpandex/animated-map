<!DOCTYPE html>
<html>
<head>
  <title>Animated Face Marker on Google Maps</title>
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    .marker-label {
      font-family: 'Arial', sans-serif;
      background: white;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      position: absolute;
      transform: translate(-50%, -100%);
      pointer-events: none;
    }
    .animated-marker {
      animation: bounce 1s infinite;
    }
    .animated-marker img {
      width: 64px;
      height: 64px;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <div id="leaderboard" style="position: absolute; top: 10px; right: 10px; background: white; padding: 16px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1002; font-size: 16px; max-height: 90vh; overflow-y: auto; line-height: 1.6; min-width: 220px;"><strong>Leaderboard</strong><ul id="leaderboard-list" style="padding-left: 18px; margin-top: 6px;"></ul></div>
  <div id="map"></div>

  <script>
    window.initMap = function() {
      const people = ["Harvey", "Isla", "Leo", "Freya", "Theo", "Grace", "Mason", "Evie", "Wayne"];
      const directionsService = new google.maps.DirectionsService();
      let routePoints = [];

      const waypoints = [
        { location: "London, UK" },
        { location: "Paris, France" },
        { location: "Brussels, Belgium" },
        { location: "Amsterdam, Netherlands" },
        { location: "Berlin, Germany" },
        { location: "Prague, Czech Republic" },
        { location: "Vienna, Austria" },
        { location: "Bratislava, Slovakia" },
        { location: "Budapest, Hungary" }
      ];

      const origin = "50.43135,-3.797092";
      const destination = "Zagreb, Croatia";

      directionsService.route({
        origin,
        destination,
        waypoints,
        travelMode: google.maps.TravelMode.DRIVING
      }, (response, status) => {
        if (status === google.maps.DirectionsStatus.OK) {
          routePoints = response.routes[0].overview_path;
          initMapWithRoute(routePoints);
        } else {
          console.error("Directions request failed: " + status);
        }
      });

      function initMapWithRoute(routePoints) {
        const segmentLengths = [];
        let totalRouteLength = 0;
        for (let i = 0; i < routePoints.length - 1; i++) {
          const dist = google.maps.geometry.spherical.computeDistanceBetween(routePoints[i], routePoints[i + 1]);
          segmentLengths.push(dist);
          totalRouteLength += dist;
        }

        const staticMarkers = people.map(name => {
          const bonus = Math.floor(Math.random() * 40001);
          let travelled = 0, segmentIndex = 0, remainingFraction = 0;
          for (let i = 0; i < routePoints.length - 1; i++) {
            const segStart = routePoints[i];
            const segEnd = routePoints[i + 1];
            const segmentDistance = google.maps.geometry.spherical.computeDistanceBetween(segStart, segEnd);
            if (travelled + segmentDistance >= bonus) {
              segmentIndex = i;
              remainingFraction = (bonus - travelled) / segmentDistance;
              break;
            }
            travelled += segmentDistance;
          }
          const startSeg = routePoints[segmentIndex];
          const endSeg = routePoints[segmentIndex + 1];
          const lat = startSeg.lat() + (endSeg.lat() - startSeg.lat()) * remainingFraction;
          const lng = startSeg.lng() + (endSeg.lng() - startSeg.lng()) * remainingFraction;
          return {
            name,
            bonus,
            img: `https://robohash.org/${name.toLowerCase()}?set=set5`,
            segmentIndex,
            remainingFraction,
            lat,
            lng
          };
        });

        class AnimatedMarker extends google.maps.OverlayView {
          constructor(position, name = "", imageUrl = "", bonus = "") {
            super();
            this.position = position;
            this.name = name;
            this.imageUrl = imageUrl;
            this.bonus = bonus;
            this.div = null;
          }
          onAdd() {
            this.div = document.createElement("div");
            this.div.className = "animated-marker";
            this.div.style.position = "absolute";
            this.div.style.width = "64px";
            this.div.style.height = "64px";
            this.div.style.zIndex = "1000";
            const img = document.createElement("img");
            img.src = this.imageUrl;
            img.alt = this.name;
            img.style.width = "100%";
            img.style.height = "100%";
            this.div.appendChild(img);
            const label = document.createElement("div");
            label.className = "marker-label";
            label.innerHTML = `<strong>${this.name}</strong><br><small>${this.bonus}</small>`;
            label.style.position = "absolute";
            label.style.top = "70px";
            label.style.left = "50%";
            label.style.transform = "translateX(-50%)";
            label.style.textAlign = "center";
            this.div.appendChild(label);
            const panes = this.getPanes();
            panes.overlayMouseTarget.appendChild(this.div);
          }
          draw() {
            const projection = this.getProjection();
            if (!projection || !this.div) return;
            const point = projection.fromLatLngToDivPixel(this.position);
            if (point) {
              this.div.style.left = `${point.x - 32}px`;
              this.div.style.top = `${point.y - 32}px`;
            }
          }
          onRemove() {
            if (this.div) this.div.remove();
          }
        }

        const map = new google.maps.Map(document.getElementById("map"), {});
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(new google.maps.LatLng(50.43135, -3.797092));
        staticMarkers.forEach(pos => bounds.extend(new google.maps.LatLng(pos.lat, pos.lng)));
        map.fitBounds(bounds);

        const maxBonus = Math.max(...staticMarkers.map(p => p.bonus));
        const sortedMarkers = [...staticMarkers].sort((a, b) => b.bonus - a.bonus);
        const leaderboardList = document.getElementById("leaderboard-list");
        leaderboardList.innerHTML = "";

        sortedMarkers.forEach((pos, index) => {
          const formattedBonus = pos.bonus.toLocaleString();
          const listItem = document.createElement("li");
          const crown = index === 0 ? "ðŸ‘‘" : "";
          listItem.textContent = `${crown} ${index + 1}. ${pos.name} ${crown}: ${formattedBonus} bonus meters`;
          leaderboardList.appendChild(listItem);

          const marker = new AnimatedMarker(
            new google.maps.LatLng(50.43135, -3.797092),
            pos.name,
            pos.img,
            `${formattedBonus} bonus meters`
          );
          marker.setMap(map);

          const targetLatLng = new google.maps.LatLng(pos.lat, pos.lng);
          let step = 0;
          const duration = 5000 * (pos.bonus / maxBonus);
          const totalSteps = Math.max(1, Math.floor(duration / (1000 / 60)));

          const personRouteLength = totalRouteLength * (pos.bonus / maxBonus);
          const segmentDistances = [];
          const personRoutePoints = [];
          let totalSoFar = 0;
          for (let i = 0; i < routePoints.length - 1; i++) {
            const dist = google.maps.geometry.spherical.computeDistanceBetween(routePoints[i], routePoints[i + 1]);
            if (totalSoFar + dist < personRouteLength) {
              personRoutePoints.push(routePoints[i]);
              segmentDistances.push(dist);
              totalSoFar += dist;
            } else {
              const remaining = personRouteLength - totalSoFar;
              const fraction = remaining / dist;
              const lat = routePoints[i].lat() + (routePoints[i + 1].lat() - routePoints[i].lat()) * fraction;
              const lng = routePoints[i].lng() + (routePoints[i + 1].lng() - routePoints[i].lng()) * fraction;
              personRoutePoints.push(routePoints[i]);
              personRoutePoints.push(new google.maps.LatLng(lat, lng));
              segmentDistances.push(remaining);
              break;
            }
          }

          const animate = () => {
            const progress = step / totalSteps;
            const personDistance = (pos.bonus / maxBonus) * totalRouteLength;
            let travelled = personDistance * progress;

            let i = 0;
            while (i < segmentDistances.length && travelled > segmentDistances[i]) {
              travelled -= segmentDistances[i];
              i++;
            }

            if (i >= personRoutePoints.length - 1) {
              marker.position = personRoutePoints[personRoutePoints.length - 1];
              marker.draw();
              return;
            }

            const start = personRoutePoints[i];
            const end = personRoutePoints[i + 1];
            const segmentLength = segmentDistances[i];
            const fraction = travelled / segmentLength;
            const lat = start.lat() + (end.lat() - start.lat()) * fraction;
            const lng = start.lng() + (end.lng() - start.lng()) * fraction;

            marker.position = new google.maps.LatLng(lat, lng);
            marker.draw();
            step++;
            if (step <= totalSteps) requestAnimationFrame(animate);
          };
          animate();
        });
      }
    };
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA23ORAayerNpeDh8WhQkwsv0ZNAon41FI&callback=initMap&libraries=geometry"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Animated Face Marker on Google Maps</title>
  <style>
    /* Map and leaderboard styling */
    #map { height: 100vh; width: 100%; }
    #leaderboard {
      position: absolute; top: 10px; right: 10px;
      background: #fff; padding: 16px; border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1002; font-family: Arial, sans-serif;
      font-size: 16px; max-height: 90vh; overflow-y: auto;
      line-height: 1.6; min-width: 260px;
    }
    #leaderboard-list { list-style: none; margin: 0; padding: 0; }
    #leaderboard-list li { display: flex; align-items: center; margin-bottom: 8px; }
    #leaderboard-list img { width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; }
  </style>
</head>
<body>
  <div id="leaderboard"><strong>Leaderboard</strong><ul id="leaderboard-list"></ul></div>
  <div id="map"></div>

  <script>
    const API_KEY = 'AIzaSyA23ORAayerNpeDh8WhQkwsv0ZNAon41FI';
    const HQ = { lat: 50.43135, lng: -3.797092 };
    const HQ_ICON = 'img/JHB Logo.png';
    const WAYPOINTS = ['London, UK','Paris, France','Brussels, Belgium','Amsterdam, Netherlands','Berlin, Germany','Prague, Czech Republic','Vienna, Austria','Bratislava, Slovakia','Budapest, Hungary'];
    const DESTINATION = 'Zagreb, Croatia';
    const PEOPLE = ['Adrian Lutic','Alex Nita','Antun Vidakovic','Bradley Tunstill','Brendon Kilcullen','Byron Claridge','Callum Evans','Cameron Gill','Christopher Scourfield','Craig Dolan','Darren Hatfield','David Mahon','Edward Shanley','Gary Mounce','George Norris','James Hickman','James Hodge-Brooks','James Rundle-Jones','Jay Dunn','Joe Lambourne-Gillen','John Peters','Jonathan Thompson','Joseph Nixon','Joseph Young','Joshua Powell','Joshua Rowberry','Lewis Cannon','Liam Hammon','Luke Piller','Mark Sneap','Morgan Hemming','Nicholas Kingshott','Richard Clanford','Richard Turvey','Robert Tamas','Ross Watson','Ryan Breslan','Ryan Manners','Tom Brooks','Tyler Webb'];

    function loadMap() {
      const service = new google.maps.DirectionsService();
      service.route({
        origin: HQ,
        destination: DESTINATION,
        waypoints: WAYPOINTS.map(loc => ({ location: loc })),
        travelMode: 'DRIVING'
      }, (res, status) => {
        if (status === 'OK') initMap(res.routes[0].overview_path);
        else console.error('Directions error:', status);
      });
    }

    async function initMap(path) {
      const map = new google.maps.Map(document.getElementById('map'));
      const bounds = new google.maps.LatLngBounds();

      // compute segment distances
      const segments = path.slice(0,-1).map((pt,i) => google.maps.geometry.spherical.computeDistanceBetween(path[i], path[i+1]));
      const cumDist = [0]; segments.forEach((d,i)=>cumDist[i+1]=cumDist[i]+d);

      // HQ marker
      new google.maps.Marker({ map, position: HQ, icon: { url: HQ_ICON, scaledSize: new google.maps.Size(64,64) }, title: 'JHB UK Ltd', zIndex: 999 });
      bounds.extend(HQ);

      // preload golden circle
      const ringImg = await loadImage('img/golden_circle.png');

      // create participants
      const participants = PEOPLE.map(name => ({
        name,
        bonus: Math.floor(Math.random()*200000),
        faceUrl: `img/${name}_cvface1.png`,
        marker: null,
        finalPos: null,
        compositeIcon: null
      }));

      // calculate final position
      participants.forEach(p => {
        let idx = cumDist.findIndex((d,i)=>p.bonus>=d && p.bonus<=cumDist[i+1]);
        if (idx<0) idx=segments.length-1;
        const [start,end] = [path[idx], path[idx+1]];
        const frac = (p.bonus-cumDist[idx])/segments[idx];
        p.finalPos = { lat: start.lat() + (end.lat()-start.lat())*frac, lng: start.lng() + (end.lng()-start.lng())*frac };
      });

      // offset small overlaps
      participants.forEach((p,i)=>{
        for(let j=0;j<i;j++){
          const a=p.finalPos, b=participants[j].finalPos;
          if(Math.hypot(a.lat-b.lat,a.lng-b.lng) < 0.001){ a.lat+=0.001; a.lng+=0.001; }
        }
      });

      // create markers
      for (const p of participants) {
        // composite icon for leader
        if (!p.compositeIcon && p === participants.reduce((a,b)=>a.bonus>b.bonus?a:b)) {
          const face = await loadImage(p.faceUrl);
          const canvas = document.createElement('canvas'); canvas.width=64; canvas.height=64;
          const ctx=canvas.getContext('2d');
          ctx.drawImage(ringImg,0,0,64,64);
          ctx.drawImage(face,8,8,48,48);
          p.compositeIcon = canvas.toDataURL();
        }
        const iconUrl = (p === participants[0]) ? p.compositeIcon : p.faceUrl;
        p.marker = new google.maps.Marker({ map, position: HQ, icon: { url: iconUrl, scaledSize: new google.maps.Size(64,64) }, title: p.name });
        bounds.extend(p.finalPos);
      }

      // fit map
      map.fitBounds(bounds);

      // leaderboard
      const lb = document.getElementById('leaderboard-list');
      participants.sort((a,b)=>b.bonus-a.bonus);
      participants.forEach((p,i) => {
        const li=document.createElement('li');
        const img = document.createElement('img');
        img.src = (i===0? p.compositeIcon : p.faceUrl);
        li.appendChild(img);
        li.appendChild(document.createTextNode(`${i===0?'ðŸ‘‘ ':''}${i+1}. ${p.name}: ${p.bonus.toLocaleString()} m`));
        lb.appendChild(li);
      });

      // animate
      participants.forEach(p=>{
        const dur = (p.bonus/200000)*5000;
        const startTime = performance.now();
        function step(now){
          const t=Math.min((now-startTime)/dur,1);
          p.marker.setPosition({ lat: HQ.lat + (p.finalPos.lat-HQ.lat)*t, lng: HQ.lng + (p.finalPos.lng-HQ.lng)*t });
          if(t<1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      });
    }

    function loadImage(src) {
      return new Promise((res, rej) => {
        const img=new Image(); img.onload=()=>res(img); img.onerror=()=>rej(src); img.src=src;
      });
    }

    // load API
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=loadMap&libraries=geometry`;
    script.async = true;
    document.head.appendChild(script);
  </script>
</body>
</html>

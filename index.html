<!DOCTYPE html>
<html>
<head>
  <title>Animated Face Marker on Google Maps</title>
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    .marker-label {
      font-family: 'Arial', sans-serif;
      background: white;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      position: absolute;
      transform: translate(-50%, -100%);
      pointer-events: none;
    }
    .animated-marker {
      animation: bounce 1s infinite;
    }
    .animated-marker img {
      width: 64px;
      height: 64px;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <div id="leaderboard" style="position: absolute; top: 10px; right: 10px; background: white; padding: 16px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1002; font-size: 16px; max-height: 90vh; overflow-y: auto; line-height: 1.6; min-width: 220px;"><strong>Leaderboard</strong><ul id="leaderboard-list" style="padding-left: 18px; margin-top: 6px;"></ul></div>
  <div id="map"></div>

  <script>
    window.initMap = function() {
      const people = ["Harvey", "Isla", "Leo", "Freya", "Theo", "Grace", "Mason", "Evie", "Wayne"];
      const routePoints = [
        new google.maps.LatLng(50.410, -3.880), // JHB HQ
        new google.maps.LatLng(51.5074, -0.1278), // London
        new google.maps.LatLng(48.8566, 2.3522), // Paris
        new google.maps.LatLng(50.8503, 4.3517), // Brussels
        new google.maps.LatLng(52.3676, 4.9041), // Amsterdam
        new google.maps.LatLng(52.5200, 13.4050), // Berlin
        new google.maps.LatLng(50.0755, 14.4378), // Prague
        new google.maps.LatLng(48.2082, 16.3738), // Vienna
        new google.maps.LatLng(48.1486, 17.1077), // Bratislava
        new google.maps.LatLng(47.4979, 19.0402), // Budapest
        new google.maps.LatLng(45.8150, 15.9819)  // Zagreb
      ];

      const totalRouteDistance = 40000;

      const staticMarkers = people.map(name => {
        const bonus = Math.floor(Math.random() * (40000 + 1));
        let travelled = 0;
        let segmentIndex = 0;
        let remainingFraction = 0;

        for (let i = 0; i < routePoints.length - 1; i++) {
          const segStart = routePoints[i];
          const segEnd = routePoints[i + 1];
          const segmentDistance = google.maps.geometry.spherical.computeDistanceBetween(segStart, segEnd);

          if (travelled + segmentDistance >= bonus) {
            segmentIndex = i;
            remainingFraction = (bonus - travelled) / segmentDistance;
            break;
          }
          travelled += segmentDistance;
        }

        const startSeg = routePoints[segmentIndex];
        const endSeg = routePoints[segmentIndex + 1];

        const lat = startSeg.lat() + (endSeg.lat() - startSeg.lat()) * remainingFraction;
        const seaSafeLat = Math.max(Math.min(lat, Math.max(startSeg.lat(), endSeg.lat())), Math.min(startSeg.lat(), endSeg.lat()));
        const lng = startSeg.lng() + (endSeg.lng() - startSeg.lng()) * remainingFraction;
        const seaSafeLng = Math.max(Math.min(lng, Math.max(startSeg.lng(), endSeg.lng())), Math.min(startSeg.lng(), endSeg.lng()));

        return {
          name,
          bonus,
          img: `https://robohash.org/${name.toLowerCase()}?set=set5`,
          segmentIndex,
          remainingFraction,
          lat: seaSafeLat,
          lng: seaSafeLng
        };
      });

      class AnimatedMarker extends google.maps.OverlayView {
        constructor(position, name = "", imageUrl = "", bonus = "") {
          super();
          this.position = position;
          this.name = name;
          this.imageUrl = imageUrl;
          this.bonus = bonus;
          this.div = null;
        }
        onAdd() {
          this.div = document.createElement("div");
          this.div.className = "animated-marker";
          this.div.style.position = "absolute";
          this.div.style.width = "64px";
          this.div.style.height = "64px";
          this.div.style.zIndex = "1000";
          this.div.style.pointerEvents = "auto";
          const img = document.createElement("img");
          img.src = this.imageUrl || "https://i.imgur.com/8Km9tLL.png";
          img.alt = this.name;
          img.style.width = "100%";
          img.style.height = "100%";
          this.div.appendChild(img);

          const label = document.createElement("div");
          label.className = "marker-label";
          label.innerHTML = `<strong>${this.name}</strong><br><small>${this.bonus}</small>`;
          label.style.position = "absolute";
          label.style.top = "70px";
          label.style.left = "50%";
          label.style.transform = "translateX(-50%)";
          label.style.textAlign = "center";
          this.div.appendChild(label);
          const panes = this.getPanes();
          panes.overlayMouseTarget.appendChild(this.div);
        }
        draw() {
          const projection = this.getProjection();
          if (!projection || !this.div) return;
          const point = projection.fromLatLngToDivPixel(this.position);
          if (point) {
            this.div.style.left = `${point.x - 32}px`;
            this.div.style.top = `${point.y - 32}px`;
          }
        }
        onRemove() {
          if (this.div) this.div.remove();
        }
      }

      const map = new google.maps.Map(document.getElementById("map"), {});
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(new google.maps.LatLng(50.410, -3.880)); // JHB HQ
      staticMarkers.forEach(pos => bounds.extend(new google.maps.LatLng(pos.lat, pos.lng)));
      const jhbLatLng = new google.maps.LatLng(50.410, -3.880);
      const furthest = staticMarkers.reduce((a, b) => a.bonus > b.bonus ? a : b);
      const furthestLatLng = new google.maps.LatLng(furthest.lat, furthest.lng);
      const displayBounds = new google.maps.LatLngBounds();
      displayBounds.extend(jhbLatLng);
      displayBounds.extend(furthestLatLng);
      const padding = 0.1;
      const southWest = new google.maps.LatLng(
        Math.min(jhbLatLng.lat(), furthestLatLng.lat()),
        Math.min(jhbLatLng.lng(), furthestLatLng.lng())
      );
      const northEast = new google.maps.LatLng(
        Math.max(jhbLatLng.lat(), furthestLatLng.lat()),
        Math.max(jhbLatLng.lng(), furthestLatLng.lng()) + padding
      );
      const paddedBounds = new google.maps.LatLngBounds(southWest, northEast);
      map.fitBounds(paddedBounds);
      // Adjust zoom based on furthest travel
      const zoomByBonus = furthest.bonus < 10000 ? 8 :
                          furthest.bonus < 20000 ? 7 :
                          furthest.bonus < 30000 ? 6 : 5;
      map.setZoom(zoomByBonus);
      
      new google.maps.Marker({
        position: { lat: 50.410, lng: -3.880 },
        map: map,
        animation: null,
        icon: {
          url: "https://maps.google.com/mapfiles/kml/shapes/info-i_maps.png",
          scaledSize: new google.maps.Size(64, 64)
        }
      });

      const sortedMarkers = staticMarkers.sort((a, b) => b.bonus - a.bonus);
      sortedMarkers.forEach((pos, index) => {
        const formattedBonus = pos.bonus.toLocaleString();
          const leaderboardList = document.getElementById("leaderboard-list");
          const listItem = document.createElement("li");
        const crown = index === 0 ? "üëë" : "";
        listItem.textContent = `${crown} ${index + 1}. ${pos.name} ${crown}: ${formattedBonus} bonus meters`;
          leaderboardList.appendChild(listItem);

          const marker = new AnimatedMarker(routePoints[0], pos.name, pos.img, `${formattedBonus} bonus meters`);
          marker.setMap(map);

          const totalDistance = pos.bonus;
          const maxDistance = 40000;
          const totalSteps = 600;
          let currentStep = 0;

          const animate = () => {
            const fraction = (totalDistance / maxDistance) * (currentStep / totalSteps);
            const totalRouteLength = routePoints.length - 1;
            let pathIndex = Math.min(Math.floor(fraction * totalRouteLength), totalRouteLength - 1);
            let segFraction = (fraction * totalRouteLength) - pathIndex;

            const start = routePoints[pathIndex];
            const end = routePoints[pathIndex + 1];
            const lat = start.lat() + (end.lat() - start.lat()) * segFraction;
            const lng = start.lng() + (end.lng() - start.lng()) * segFraction + (Math.random() - 0.5) * 0.01;

            marker.position = new google.maps.LatLng(lat, lng);
            marker.draw();

            currentStep++;
            if (currentStep <= totalSteps) requestAnimationFrame(animate);
          };

          animate();

          // Removed duplicate interval block
        });
    };
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA23ORAayerNpeDh8WhQkwsv0ZNAon41FI&callback=initMap&libraries=geometry">
  </script>
  <p style="padding: 1em; font-size: 14px; color: red;">
    ‚ö†Ô∏è If you're seeing a Google Maps error: <strong>RefererNotAllowedMapError</strong>, you must authorise the following URL in your Google Cloud Console:<br>
    <code>https://web-sandbox.oaiusercontent.com/index.html</code>
  </p>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Animated Face Marker on Google Maps</title>
  <style>
    /* Map and leaderboard styling */
    #map { height: 100vh; width: 100%; }
    #leaderboard {
      position: absolute;
      top: 10px; right: 10px;
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1002;
      font-family: Arial, sans-serif;
      font-size: 16px;
      max-height: 90vh;
      overflow-y: auto;
      line-height: 1.6;
      min-width: 220px;
    }
    .marker-label {
      position: absolute;
      transform: translate(-50%, -100%);
      pointer-events: none;
      padding: 4px 6px;
      font-size: 12px;
      background: #fff;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <div id="leaderboard">
    <strong>Leaderboard</strong>
    <ul id="leaderboard-list"></ul>
  </div>
  <div id="map"></div>

  <script>
    // Configuration
    const API_KEY = 'AIzaSyA23ORAayerNpeDh8WhQkwsv0ZNAon41FI';
    const HQ = { lat: 50.43135, lng: -3.797092, icon: 'img/JHB Logo.png' };
    const WAYPOINTS = [
      'London, UK','Paris, France','Brussels, Belgium','Amsterdam, Netherlands',
      'Berlin, Germany','Prague, Czech Republic','Vienna, Austria',
      'Bratislava, Slovakia','Budapest, Hungary'
    ];
    const DESTINATION = 'Zagreb, Croatia';
    const PEOPLE = [
      'Adrian Lutic','Alex Nita','Antun Vidakovic','Bradley Turnstill','Brendon Kilcullen',
      'Byron Claridge','Callum Evans','Cameron Gill','Christopher Scourfield','Craig Dolan',
      'Darren Hatfield','David Mahon','Edward Shanley','Gary Mounce','George Norris',
      'James Hickman','James Hodge-Brooks','James Rundle-Jones','Jay Dunn','Joe Lambourne-Gillen',
      'John Peters','Jonathan Thompson','Joseph Nixon','Joseph Young','Joshua Powell',
      'Joshua Rowberry','Lewis Cannon','Liam Hammon','Luke Piller','Mark Sneap',
      'Morgan Hemming','Nicholas Kingshott','Richard Clanford','Richard Turvey',
      'Robert Tamas','Ross Watson','Ryan Breslan','Ryan Manners','Tom Brooks','Tyler Webb'
    ];

    function loadMap() {
      new google.maps.DirectionsService().route({
        origin: HQ,
        destination: DESTINATION,
        waypoints: WAYPOINTS.map(loc => ({ location: loc })),
        travelMode: 'DRIVING'
      }, (res, status) => {
        if (status !== 'OK') return console.error('Directions error', status);
        initMap(res.routes[0].overview_path);
      });
    }

    function initMap(path) {
      const map = new google.maps.Map(document.getElementById('map'));
      const bounds = new google.maps.LatLngBounds();
      const distances = computeSegments(path);

      // Place HQ marker
      placeMarker(map, HQ, { url: HQ.icon, size: [115,64], anchor: [80,64], title: 'JHB UK Ltd' });
      bounds.extend(HQ);

      // Generate participants
      const participants = PEOPLE.map((name,i) => createParticipant(name, path, distances, i));
      preventOverlap(participants, 0.0003);
      participants.forEach(p => bounds.extend(p.position));
      map.fitBounds(bounds);

      // Sort & display leaderboard
      participants.sort((a,b) => b.bonus - a.bonus);
      updateLeaderboard(participants);

      // Place participant markers
      participants.forEach(p => placeMarker(map, p.position, { url: p.img, size: [64,64], anchor: [32,64], title: `${p.name}: ${p.bonus}` }));
    }

    function computeSegments(path) {
      return path.slice(0,-1).map((_,i) =>
        google.maps.geometry.spherical.computeDistanceBetween(path[i], path[i+1])
      );
    }

    function createParticipant(name, path, segs, index) {
      const bonus = Math.floor(Math.random()*40000);
      let dist=0, idx=0;
      while(idx<segs.length && dist+segs[idx]<bonus) dist+=segs[idx++];
      const frac = (bonus-dist)/segs[idx];
      const start = path[idx], end = path[idx+1];
      const lat = start.lat() + (end.lat()-start.lat())*frac;
      const lng = start.lng() + (end.lng()-start.lng())*frac;
      return { name, bonus, img: `img/${name}.png`, position:{ lat, lng } };
    }

    // Shift overlapping markers by at least minOffset in lat/lng
target.preventOverlap = function(list, minOffset) {
  let moved;
  do {
    moved = false;
    for (let i = 0; i < list.length; i++) {
      for (let j = i + 1; j < list.length; j++) {
        const a = list[i].position;
        const b = list[j].position;
        const dx = b.lng - a.lng, dy = b.lat - a.lat;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < minOffset) {
          const angle = Math.random() * 2 * Math.PI;
          const shift = (minOffset - dist) / 2;
          // Move both points away from each other
          a.lat -= Math.cos(angle) * shift;
          a.lng -= Math.sin(angle) * shift;
          b.lat += Math.cos(angle) * shift;
          b.lng += Math.sin(angle) * shift;
          moved = true;
        }
      }
    }
  } while (moved);
};

        }
      }
    }

    function placeMarker(map, pos, {url, size, anchor, title}) {
      new google.maps.Marker({
        position: pos,
        map,
        title,
        icon: url && { url, scaledSize: new google.maps.Size(...size), anchor: new google.maps.Point(...anchor) }
      });
    }

    function updateLeaderboard(list) {
      const ul = document.getElementById('leaderboard-list'); ul.innerHTML='';
      list.forEach((p,i)=>{
        const li=document.createElement('li');
        li.textContent=`${i===0?'ðŸ‘‘':''} ${i+1}. ${p.name}: ${p.bonus.toLocaleString()} bonus meters`;
        ul.appendChild(li);
      });
    }

    // Load Google Maps API
    const script=document.createElement('script');
    script.src=`https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=loadMap&libraries=geometry`;
    script.async=true;document.head.appendChild(script);
  </script>
</body>
</html>

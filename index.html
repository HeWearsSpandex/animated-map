<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Animated Face Marker on Google Maps</title>
  <style>
    /* Map and leaderboard styling */
    #map { height: 100vh; width: 100%; }
    #leaderboard {
      position: absolute; top: 10px; right: 10px;
      background: #fff; padding: 16px; border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1002; font-family: Arial, sans-serif;
      font-size: 16px; max-height: 90vh; overflow-y: auto;
      line-height: 1.6; min-width: 260px;
    }
    #leaderboard-list img {
      vertical-align: middle;
      width: 24px; height: 24px;
      border-radius: 50%;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div id="leaderboard">
    <strong>Leaderboard</strong>
    <ul id="leaderboard-list"></ul>
  </div>
  <div id="map"></div>

  <!-- Async load -->
  <script
    async
    defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA23ORAayerNpeDh8WhQkwsv0ZNAon41FI&callback=initMap&libraries=geometry,marker">
  </script>

  <script>
    const API_KEY = 'AIzaSyA23ORAayerNpeDh8WhQkwsv0ZNAon41FI';
    const HQ = { lat: 50.43135, lng: -3.797092 };
    const HQ_ICON = 'img/JHB Logo.png';  // untouched
    const WAYPOINTS = ['London, UK','Paris, France','Brussels, Belgium','Amsterdam, Netherlands','Berlin, Germany','Prague, Czech Republic','Vienna, Austria','Bratislava, Slovakia','Budapest, Hungary'];
    const DESTINATION = 'Zagreb, Croatia';
    const PEOPLE = ['Adrian Lutic','Alex Nita','Antun Vidakovic','Bradley Tunstill','Brendon Kilcullen','Byron Claridge','Callum Evans','Cameron Gill','Christopher Scourfield','Craig Dolan','Darren Hatfield','David Mahon','Edward Shanley','Gary Mounce','George Norris','James Hickman','James Hodge-Brooks','James Rundle-Jones','Jay Dunn','Joe Lambourne-Gillen','John Peters','Jonathan Thompson','Joseph Nixon','Joseph Young','Joshua Powell','Joshua Rowberry','Lewis Cannon','Liam Hammon','Luke Piller','Mark Sneap','Morgan Hemming','Nicholas Kingshott','Richard Clanford','Richard Turvey','Robert Tamas','Ross Watson','Ryan Breslan','Ryan Manners','Tom Brooks','Tyler Webb'];
    const GOLDEN_CIRCLE = 'img/golden_circle.png';

    function initMap() {
      const directions = new google.maps.DirectionsService();
      directions.route({
        origin: HQ,
        destination: DESTINATION,
        waypoints: WAYPOINTS.map(loc => ({ location: loc })),
        travelMode: 'DRIVING'
      }, (res, status) => {
        if (status === 'OK') drawAnimatedMap(res.routes[0].overview_path);
        else console.error('Directions error:', status);
      });
    }

    function drawAnimatedMap(path) {
      const map = new google.maps.Map(document.getElementById('map'));
      const bounds = new google.maps.LatLngBounds();

      // compute segments & cumulative distances
      const segments = path.slice(0,-1).map((pt,i) =>
        google.maps.geometry.spherical.computeDistanceBetween(path[i], path[i+1])
      );
      const cumDist = [0];
      segments.forEach((d,i)=> cumDist[i+1]=cumDist[i]+d);

      // HQ marker
      new google.maps.marker.AdvancedMarkerElement({
        map,
        position: HQ,
        icon: {
          url: HQ_ICON,
          size: new google.maps.Size(64,64),
          scaledSize: new google.maps.Size(64,64),
        },
        title: 'JHB UK Ltd',
      });
      bounds.extend(HQ);

      // build participants
      const participants = PEOPLE.map(name => {
        const bonus = Math.floor(Math.random()*200000);
        const marker = new google.maps.marker.AdvancedMarkerElement({
          map,
          position: HQ,
          icon: {
            url: `img/${encodeURIComponent(name)}_cvface1.png`,
            size: new google.maps.Size(64,64),
            scaledSize: new google.maps.Size(64,64),
          },
          title: name,
        });
        return { name, bonus, marker };
      });

      // compute final positions
      participants.forEach(p => {
        // find segment
        let idx = cumDist.findIndex((d,i)=> p.bonus < cumDist[i+1]);
        if (idx < 0) idx = segments.length-1;
        const start = path[idx], end = path[idx+1] || path[idx];
        const frac = Math.min((p.bonus - cumDist[idx]) / (segments[idx]||1), 1);
        p.finalPos = {
          lat: start.lat() + (end.lat()-start.lat())*frac + (Math.random()-0.5)*0.002,
          lng: start.lng() + (end.lng()-start.lng())*frac + (Math.random()-0.5)*0.002
        };
      });

      // fit bounds
      participants.forEach(p=> bounds.extend(p.finalPos));
      map.fitBounds(bounds);

      // render leaderboard
      participants.sort((a,b)=> b.bonus - a.bonus);
      const lb = document.getElementById('leaderboard-list');
      lb.innerHTML = '';
      participants.forEach((p,i)=> {
        const li = document.createElement('li');
        let imgTag = `<img src="img/${encodeURIComponent(p.name)}_cvface1.png" alt="${p.name}" />`;
        if (i===0) {
          // wrap leader in golden circle
          li.innerHTML = `<img src="${GOLDEN_CIRCLE}" style="width:24px;height:24px;vertical-align:middle;margin-right:8px;">` +
                         imgTag +
                         `ðŸ‘‘ ${i+1}. ${p.name}: ${p.bonus.toLocaleString()} m`;
        } else {
          li.innerHTML = `${imgTag} ${i+1}. ${p.name}: ${p.bonus.toLocaleString()} m`;
        }
        lb.appendChild(li);
      });

      // animate
      participants.forEach(p => {
        const dur = p.bonus/200000*5000;
        const start = performance.now();
        const step = now => {
          const t = Math.min((now-start)/dur,1);
          const pos = {
            lat: HQ.lat + (p.finalPos.lat-HQ.lat)*t,
            lng: HQ.lng + (p.finalPos.lng-HQ.lng)*t
          };
          // AdvancedMarkerElement uses .position
          if (typeof p.marker.setPosition === 'function') {
            p.marker.setPosition(pos);
          } else {
            p.marker.position = pos;
          }
          if (t<1) requestAnimationFrame(step);
        };
        requestAnimationFrame(step);
      });
    }
  </script>
</body>
</html>

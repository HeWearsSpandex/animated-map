<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Animated Face Marker on Google Maps</title>
  <style>
    /* Full-screen map + leaderboard styling */
    #map { height: 100vh; width: 100%; }
    #leaderboard {
      position: absolute; top: 10px; right: 10px;
      background: #fff; padding: 16px; border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1002; font-family: Arial, sans-serif;
      font-size: 16px; max-height: 90vh; overflow-y: auto;
      line-height: 1.6; min-width: 240px;
    }
    #leaderboard li {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    #leaderboard img {
      width: 32px; height: 32px;
      margin-right: 8px;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <div id="leaderboard">
    <strong>Leaderboard</strong>
    <ul id="leaderboard-list"></ul>
  </div>
  <div id="map"></div>

  <script>
    // This callback is invoked by the Maps API when it finishes loading
    window.initMap = async function() {
      const HQ = { lat: 50.43135, lng: -3.797092 };
      const DEST = 'Zagreb, Croatia';
      const WAYPOINTS = [
        'London, UK','Paris, France','Brussels, Belgium',
        'Amsterdam, Netherlands','Berlin, Germany',
        'Prague, Czech Republic','Vienna, Austria',
        'Bratislava, Slovakia','Budapest, Hungary'
      ];

      // First name in this list is treated as leader
      const NAMES = [
        'Adrian Lutic','Alex Nita','Antun Vidakovic','Bradley Tunstill',
        'Brendon Kilcullen','Byron Claridge','Callum Evans','Cameron Gill',
        'Christopher Scourfield','Craig Dolan','Darren Hatfield','David Mahon',
        'Edward Shanley','Gary Mounce','George Norris','James Hickman',
        'James Hodge-Brooks','James Rundle-Jones','Jay Dunn','Joe Lambourne-Gillen',
        'John Peters','Jonathan Thompson','Joseph Nixon','Joseph Young',
        'Joshua Powell','Joshua Rowberry','Lewis Cannon','Liam Hammon',
        'Luke Piller','Mark Sneap','Morgan Hemming','Nicholas Kingshott',
        'Richard Clanford','Richard Turvey','Robert Tamas','Ross Watson',
        'Ryan Breslan','Ryan Manners','Tom Brooks','Tyler Webb'
      ];

      // 1. Get driving route
      const ds = new google.maps.DirectionsService();
      const res = await ds.route({
        origin: HQ, destination: DEST,
        waypoints: WAYPOINTS.map(loc => ({ location: loc })),
        travelMode: 'DRIVING'
      });
      const path = res.routes[0].overview_path;

      // 2. Precompute cumulative distances along the path
      const segments = path.slice(0, -1).map((pt, i) =>
        google.maps.geometry.spherical.computeDistanceBetween(path[i], path[i+1])
      );
      const cumDist = [0];
      segments.forEach((d, i) => cumDist[i+1] = cumDist[i] + d);

      // 3. Helper: merge golden circle + face into a single data-URL icon
      function makeIcon(faceUrl) {
        return new Promise((resolve, reject) => {
          const canvas = document.createElement('canvas');
          canvas.width = 64; canvas.height = 64;
          const ctx = canvas.getContext('2d');
          const ring = new Image();
          const face = new Image();
          ring.src = 'img/golden_circle.png';
          face.src = faceUrl;
          ring.onload = () => {
            face.onload = () => {
              // draw circle then face over it
              ctx.drawImage(ring, 0, 0, 64, 64);
              ctx.drawImage(face, 0, 0, 64, 64);
              resolve(canvas.toDataURL());
            };
            face.onerror = reject;
          };
          ring.onerror = reject;
        });
      }

      // 4. Initialize map & bounds
      const map = new google.maps.Map(document.getElementById('map'));
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(HQ);

      // 5. Create all participants
      const participants = await Promise.all(NAMES.map(async (name, idx) => {
        const bonus = Math.floor(Math.random() * 200000);
        const isLeader = idx === 0;
        const faceUrl = `img/${encodeURIComponent(name)}_cvface1.png`;
        let iconUrl = faceUrl;
        if (isLeader) {
          // leader gets the circle-wrapped icon
          iconUrl = await makeIcon(faceUrl);
        }
        const marker = new google.maps.Marker({
          map,
          title: name,
          position: HQ,
          icon: {
            url: iconUrl,
            scaledSize: new google.maps.Size(64, 64),
            anchor: new google.maps.Point(32, 32)
          }
        });
        return { name, bonus, marker, isLeader };
      }));

      // 6. Compute each final position along the route
      participants.forEach(p => {
        let i = cumDist.findIndex((d, j) => p.bonus >= d && p.bonus <= cumDist[j+1]);
        if (i < 0) i = segments.length - 1;
        const A = path[i], B = path[i+1];
        const frac = (p.bonus - cumDist[i]) / segments[i];
        p.pos = {
          lat: A.lat() + (B.lat() - A.lat()) * frac,
          lng: A.lng() + (B.lng() - A.lng()) * frac
        };
      });

      // 7. Nudge any overlapping points
      participants.forEach((p, i) => {
        for (let j = 0; j < i; j++) {
          const a = p.pos, b = participants[j].pos;
          if (Math.hypot(a.lat - b.lat, a.lng - b.lng) < 0.0004) {
            a.lat += 0.0004;
            a.lng += 0.0004;
          }
        }
      });

      // 8. Place markers and extend bounds
      participants.forEach(p => {
        p.marker.setPosition(p.pos);
        bounds.extend(p.pos);
      });
      map.fitBounds(bounds);

      // 9. Build the leaderboard
      participants.sort((a, b) => b.bonus - a.bonus);
      const ul = document.getElementById('leaderboard-list');
      ul.innerHTML = '';
      for (let i = 0; i < participants.length; i++) {
        const p = participants[i];
        const li = document.createElement('li');
        const img = document.createElement('img');
        // small 32Ã—32 thumbnail: circle + face for leader, plain face otherwise
        if (p.isLeader) {
          img.src = await makeIcon(`img/${encodeURIComponent(p.name)}_cvface1.png`);
        } else {
          img.src = `img/${encodeURIComponent(p.name)}_cvface1.png`;
        }
        li.appendChild(img);
        li.appendChild(
          document.createTextNode(`${i+1}. ${p.name} (${p.bonus.toLocaleString()} m)`)
        );
        ul.appendChild(li);
      }
    };

    // Load the Maps API asynchronously
    const script = document.createElement('script');
    script.src =
      'https://maps.googleapis.com/maps/api/js' +
      '?key=AIzaSyA23ORAayerNpeDh8WhQkwsv0ZNAon41FI' +
      '&callback=initMap&libraries=geometry';
    script.async = true;
    document.head.appendChild(script);
  </script>
</body>
</html>

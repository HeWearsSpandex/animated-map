<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Animated Face Marker on Google Maps</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    #leaderboard {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1002;
      font-family: Arial, sans-serif;
      font-size: 16px;
      max-height: 90%;
      overflow-y: auto;
      line-height: 1.6;
      min-width: 260px;
    }
    #leaderboard img {
      width: 32px;
      height: 32px;
      vertical-align: middle;
      margin-right: 8px;
      border-radius: 50%;
    }
    #leaderboard li { margin-bottom: 8px; }
  </style>
</head>
<body>
  <div id="leaderboard">
    <strong>Leaderboard</strong>
    <ul id="leaderboard-list"></ul>
  </div>
  <div id="map"></div>

  <script>
    // Your Google Maps API key
    const API_KEY = 'AIzaSyA23ORAayerNpeDh8WhQkwsv0ZNAon41FI';
    const IMG_PATH = 'img/';
    const CIRCLE_SRC = IMG_PATH + 'golden_circle.png';
    const HQ = { lat: 50.43135, lng: -3.797092 };
    const PEOPLE = [
      'Adrian Lutic', 'Alex Nita', 'Antun Vidakovic', 'Bradley Tunstill', 'Brendon Kilcullen',
      'Byron Claridge', 'Callum Evans', 'Cameron Gill', 'Christopher Scourfield', 'Craig Dolan',
      'Edward Shanley', 'Gary Mounce', 'George Norris', 'James Hickman', 'James Hodge-Brooks',
      'James Rundle-Jones', 'James Whiteoak', 'Jay Dunn', 'Joe Lambourne-Gillen', 'John Peters',
      'Jonathan Thompson', 'Joseph Nixon', 'Joseph Young', 'Joshua Powell', 'Joshua Rowberry',
      'Lewis Cannon', 'Liam Hammon', 'Luke Piller', 'Mark Sneap', 'Mark Stafford',
      'Morgan Hemming', 'Nicholas Kingshott', 'Richard Clanford', 'Robert Tamas', 'Ross Watson',
      'Ryan Breslan', 'Ryan Manners', 'Tom Brooks', 'Tristan Allen', 'Tyler Webb'
    ];
    const DESTINATION = 'Zagreb, Croatia';
    const WAYPOINTS = [
      'London, UK', 'Paris, France', 'Brussels, Belgium', 'Amsterdam, Netherlands',
      'Berlin, Germany', 'Prague, Czech Republic', 'Vienna, Austria',
      'Bratislava, Slovakia', 'Budapest, Hungary'
    ];

    // Load an image and return an HTMLImageElement
    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }

    // Draw face and optional circle onto canvas, return data URL
    async function drawIcon(name, useCircle) {
      const face = await loadImage(`${IMG_PATH}${encodeURIComponent(name)}_cvface1.png`);
      const size = 64;
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = size;
      const ctx = canvas.getContext('2d');
      if (useCircle) {
        const circle = await loadImage(CIRCLE_SRC);
        ctx.drawImage(circle, 0, 0, size, size);
      }
      ctx.drawImage(face, 0, 0, size, size);
      return canvas.toDataURL('image/png');
    }

    // Initialize map and request route
    function initMap() {
      window.map = new google.maps.Map(document.getElementById('map'));
      const ds = new google.maps.DirectionsService();
      ds.route({
        origin: HQ,
        destination: DESTINATION,
        waypoints: WAYPOINTS.map(loc => ({ location: loc })),
        travelMode: google.maps.TravelMode.DRIVING
      }, (result, status) => {
        if (status === 'OK') animateRoute(result.routes[0].overview_path);
        else console.error('Directions error:', status);
      });
    }

    // Animate markers along the path and update leaderboard
    async function animateRoute(path) {
      const map = window.map;
      // Add HQ marker
      new google.maps.Marker({
        map,
        position: HQ,
        icon: { url: `${IMG_PATH}JHB Logo.png`, scaledSize: new google.maps.Size(32,32) },
        title: 'JHB UK Ltd'
      });

      // Compute segment distances and cumulative sums
      const distances = path.slice(0,-1).map((_,i) =>
        google.maps.geometry.spherical.computeDistanceBetween(path[i], path[i+1])
      );
      const cumulative = distances.reduce((arr, d) => { arr.push((arr.slice(-1)[0]||0) + d); return arr; }, []);

      // Create participants with random bonus distance
      const participants = await Promise.all(PEOPLE.map(async name => {
        const bonus = Math.random() * cumulative[cumulative.length-1];
        let idx = cumulative.findIndex(d => bonus <= d);
        if (idx < 0) idx = cumulative.length - 1;
        const prev = cumulative[idx-1]||0;
        const frac = (bonus - prev) / distances[idx];
        const p0 = path[idx], p1 = path[idx+1];
        const target = {
          lat: p0.lat() + (p1.lat() - p0.lat()) * frac,
          lng: p0.lng() + (p1.lng() - p0.lng()) * frac
        };
        const iconUrl = await drawIcon(name, false);
        const marker = new google.maps.Marker({
          map,
          position: HQ,
          icon: { url: iconUrl, scaledSize: new google.maps.Size(64,64) },
          title: name
        });
        return { name, bonus, marker, target };
      }));

      // Fit map to show all endpoints
      const bounds = new google.maps.LatLngBounds();
      participants.forEach(p => bounds.extend(p.target));
      bounds.extend(HQ);
      map.fitBounds(bounds);

      // Animate each marker from HQ to its target
      participants.forEach(p => {
        const start = performance.now();
        const duration = 5000;
        (function move(now) {
          const t = Math.min((now - start) / duration, 1);
          p.marker.setPosition({
            lat: HQ.lat + (p.target.lat - HQ.lat) * t,
            lng: HQ.lng + (p.target.lng - HQ.lng) * t
          });
          if (t < 1) requestAnimationFrame(move);
        })(start);
      });

      // Determine leader and circle their icon
      participants.sort((a,b) => b.bonus - a.bonus);
      const leader = participants[0];
      const circled = await drawIcon(leader.name, true);
      leader.marker.setIcon({ url: circled, scaledSize: new google.maps.Size(80,80), anchor: new google.maps.Point(40,40) });

      // Build leaderboard list
      const lb = document.getElementById('leaderboard-list');
      lb.innerHTML = '';
      participants.forEach((p,i) => {
        const li = document.createElement('li');
        const img = document.createElement('img');
        img.src = i === 0 ? circled : p.marker.getIcon().url;
        li.appendChild(img);
        li.appendChild(document.createTextNode(`${i+1}. ${p.name}: ${Math.round(p.bonus)} m`));
        lb.appendChild(li);
      });
    }
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA23ORAayerNpeDh8WhQkwsv0ZNAon41FI&libraries=geometry&callback=initMap">
  </script>
</body>
</html>

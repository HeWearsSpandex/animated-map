<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Animated Face Marker on Google Maps</title>
  <style>
    #map { height: 100vh; width: 100%; }
    #leaderboard {
      position: absolute; top: 10px; right: 10px;
      background: #fff; padding: 16px; border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1002; font-family: Arial, sans-serif;
      font-size: 16px; max-height: 90vh; overflow-y: auto;
      line-height: 1.6; min-width: 260px;
    }
    #leaderboard-list img {
      vertical-align: middle; width: 32px; height: 32px;
      margin-right: 8px; border-radius: 50%;
    }
  </style>
</head>
<body>
  <div id="leaderboard">
    <strong>Leaderboard</strong>
    <ul id="leaderboard-list"></ul>
  </div>
  <div id="map"></div>

  <script>
    const API_KEY = 'AIzaSyA23ORAayerNpeDh8WhQkwsv0ZNAon41FI';
    const HQ = { lat: 50.43135, lng: -3.797092 };
    const HQ_ICON = 'img/JHB%20Logo.png';
    const WAYPOINTS = ['London, UK','Paris, France','Brussels, Belgium','Amsterdam, Netherlands',
                       'Berlin, Germany','Prague, Czech Republic','Vienna, Austria',
                       'Bratislava, Slovakia','Budapest, Hungary'];
    const DESTINATION = 'Zagreb, Croatia';
    const PEOPLE = [ /* ...your names... */ ];

    function makePlaceholderImg(size=64) {
      const cv = document.createElement('canvas');
      cv.width = cv.height = size;
      const ctx = cv.getContext('2d');
      ctx.fillStyle = '#ccc';
      ctx.fillRect(0,0,size,size);
      return cv;
    }

    function loadImage(src, size=64) {
      return new Promise(res => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload  = () => res(img);
        img.onerror = () => res(makePlaceholderImg(size));
        img.src = src;
      });
    }

    function loadMap() {
      new google.maps.DirectionsService().route({
        origin: HQ,
        destination: DESTINATION,
        waypoints: WAYPOINTS.map(loc => ({ location: loc })),
        travelMode: 'DRIVING'
      }, (res, status) => {
        if (status === 'OK') initMap(res.routes[0].overview_path);
        else console.error('Directions error:', status);
      });
    }

    async function initMap(path) {
      const map = new google.maps.Map(document.getElementById('map'));
      const bounds = new google.maps.LatLngBounds();

      // choose AdvancedMarkerElement if available, else fallback
      const MarkerClass = google.maps.marker?.AdvancedMarkerElement
        ? google.maps.marker.AdvancedMarkerElement
        : google.maps.Marker;

      // HQ marker
      new MarkerClass({
        map, position: HQ,
        icon: {
          url: HQ_ICON,
          scaledSize: new google.maps.Size(64,64),
          anchor: new google.maps.Point(32,32)
        },
        title: 'JHB UK Ltd',
        zIndex: 999
      });
      bounds.extend(HQ);

      // compute route segments & cumulative distances
      const segments = path.slice(0,-1).map((pt,i)=>
        google.maps.geometry.spherical.computeDistanceBetween(path[i],path[i+1])
      );
      const cumDist = [0];
      segments.forEach((d,i)=> cumDist[i+1] = cumDist[i] + d);

      // build participants
      const participants = PEOPLE.map(name=>({
        name, bonus: Math.floor(Math.random()*200000), marker:null, finalPos:null
      }));
      participants.forEach(p=>{
        let idx = cumDist.findIndex((d,i)=>p.bonus>=d&&p.bonus<=(cumDist[i+1]||d));
        if(idx<0) idx=segments.length-1;
        const s=path[idx], e=path[idx+1]||s;
        const frac = segments[idx] ? (p.bonus-cumDist[idx])/segments[idx] : 0;
        p.finalPos = { lat: s.lat() + (e.lat()-s.lat())*frac, lng: s.lng() + (e.lng()-s.lng())*frac };
      });
      participants.sort((a,b)=>b.bonus-a.bonus);
      const leader = participants[0];

      // preload images
      const circleImg = await loadImage('img/golden_circle.png',64);
      const faceImgs = await Promise.all(participants.map(p=>
        loadImage(`img/${encodeURIComponent(p.name)}_cvface1.png`,64)
      ));

      function makeLeaderIcon(faceImg){
        const size=64, inset=8;
        const cv=document.createElement('canvas');
        cv.width=cv.height=size;
        const ctx=cv.getContext('2d');
        ctx.drawImage(circleImg,0,0,size,size);
        ctx.save();
        ctx.beginPath();
        ctx.arc(size/2,size/2,(size/2)-inset,0,2*Math.PI);
        ctx.clip();
        ctx.drawImage(faceImg,inset,inset,size-2*inset,size-2*inset);
        ctx.restore();
        return {
          url: cv.toDataURL(),
          scaledSize: new google.maps.Size(size,size),
          anchor: new google.maps.Point(size/2,size/2)
        };
      }

      // place & animate
      participants.forEach((p,i)=>{
        const isLeader = p===leader;
        const iconOpts = isLeader
          ? makeLeaderIcon(faceImgs[i])
          : {
              url: faceImgs[i].src,
              scaledSize: new google.maps.Size(64,64),
              anchor: new google.maps.Point(32,32)
            };

        p.marker = new MarkerClass({ map, position: HQ, icon: iconOpts, title: p.name });

        const start=performance.now(),
              duration=(p.bonus/200000)*5000;
        (function step(now){
          const t=Math.min((now-start)/duration,1);
          p.marker.position = {
            lat: HQ.lat + (p.finalPos.lat-HQ.lat)*t,
            lng: HQ.lng + (p.finalPos.lng-HQ.lng)*t
          };
          if(t<1) requestAnimationFrame(step);
        })(start);

        bounds.extend(p.finalPos);
      });

      map.fitBounds(bounds);

      // leaderboard
      const lb = document.getElementById('leaderboard-list');
      participants.forEach((p,i)=>{
        const li = document.createElement('li'),
              img = document.createElement('img');
        img.src = (p===leader ? makeLeaderIcon(faceImgs[i]).url : faceImgs[i].src);
        li.appendChild(img);
        li.appendChild(document.createTextNode(
          `${i===0?'ðŸ‘‘ ':''}${i+1}. ${p.name}: ${p.bonus.toLocaleString()} m`
        ));
        lb.appendChild(li);
      });
    }

    // load Maps API with both geometry & marker
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}
                  &callback=loadMap
                  &libraries=geometry,marker`;
    script.async = true; script.defer = true;
    document.head.appendChild(script);
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Animated Face Marker on Google Maps</title>
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    .marker-label {
      font-family: 'Arial', sans-serif;
      background: white;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      position: absolute;
      transform: translate(-50%, -100%);
      pointer-events: none;
    }
    .animated-marker {
      animation: bounce 1s infinite;
    }
    .animated-marker img {
      width: 64px;
      height: 64px;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <div id="leaderboard" style="position: absolute; top: 10px; right: 10px; background: white; padding: 16px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1002; font-size: 16px; max-height: 90vh; overflow-y: auto; line-height: 1.6; min-width: 220px;"><strong>Leaderboard</strong><ul id="leaderboard-list" style="padding-left: 18px; margin-top: 6px;"></ul></div>
  <div id="map"></div>

  <script>
    window.initMap = function() {
      const people = ["Harvey", "Isla", "Leo", "Freya", "Theo", "Grace", "Mason", "Evie", "Wayne"];
      const directionsService = new google.maps.DirectionsService();
      let routePoints = [];

      const waypoints = [
        { location: "London, UK" },
        { location: "Paris, France" },
        { location: "Brussels, Belgium" },
        { location: "Amsterdam, Netherlands" },
        { location: "Berlin, Germany" },
        { location: "Prague, Czech Republic" },
        { location: "Vienna, Austria" },
        { location: "Bratislava, Slovakia" },
        { location: "Budapest, Hungary" }
      ];

      const origin = "50.43135,-3.797092";
      const destination = "Zagreb, Croatia";

      directionsService.route({
        origin,
        destination,
        waypoints,
        travelMode: google.maps.TravelMode.DRIVING
      }, (response, status) => {
        if (status === google.maps.DirectionsStatus.OK) {
          routePoints = response.routes[0].overview_path;
          initMapWithRoute(routePoints);
        } else {
          console.error("Directions request failed: " + status);
        }
      });

      function initMapWithRoute(routePoints) {
        const segmentLengths = [];
        let totalRouteLength = 0;
        for (let i = 0; i < routePoints.length - 1; i++) {
          const dist = google.maps.geometry.spherical.computeDistanceBetween(routePoints[i], routePoints[i + 1]);
          segmentLengths.push(dist);
          totalRouteLength += dist;
        }

        const staticMarkers = people.map(name => {
          const bonus = Math.floor(Math.random() * 40000);
          let travelled = 0, segmentIndex = 0, remainingFraction = 0;
          for (let i = 0; i < routePoints.length - 1; i++) {
            const segStart = routePoints[i];
            const segEnd = routePoints[i + 1];
            const segmentDistance = google.maps.geometry.spherical.computeDistanceBetween(segStart, segEnd);
            if (travelled + segmentDistance >= bonus) {
              segmentIndex = i;
              remainingFraction = (bonus - travelled) / segmentDistance;
              break;
            }
            travelled += segmentDistance;
          }
          const startSeg = routePoints[segmentIndex];
          const endSeg = routePoints[segmentIndex + 1];
          const lat = startSeg.lat() + (endSeg.lat() - startSeg.lat()) * remainingFraction;
          const lng = startSeg.lng() + (endSeg.lng() - startSeg.lng()) * remainingFraction;
          return {
            name,
            bonus,
            img: `https://robohash.org/${name.toLowerCase()}?set=set5`,
            segmentIndex,
            remainingFraction,
            lat,
            lng
          };
        });

        const map = new google.maps.Map(document.getElementById("map"), {});
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(new google.maps.LatLng(50.43135, -3.797092));
        staticMarkers.forEach(pos => bounds.extend(new google.maps.LatLng(pos.lat, pos.lng)));
        map.fitBounds(bounds);

        // Add JHB HQ marker with logo, scaled by height and preserving aspect ratio
        new google.maps.Marker({
          position: { lat: 50.43135, lng: -3.797092 },
          map,
          title: "JHB UK Ltd",
          icon: {
            url: "https://hewearsspandex.github.io/animated-map/JHB%20Logo.png",
            scaledSize: new google.maps.Size(160, 64),
            anchor: new google.maps.Point(80, 64)
          }
        });

        const maxBonus = Math.max(...staticMarkers.map(p => p.bonus));
        const sortedMarkers = [...staticMarkers].sort((a, b) => b.bonus - a.bonus);
        const leaderboardList = document.getElementById("leaderboard-list");
        leaderboardList.innerHTML = "";

        sortedMarkers.forEach((pos, index) => {
          const formattedBonus = pos.bonus.toLocaleString();
          const listItem = document.createElement("li");
          const crown = index === 0 ? "ðŸ‘‘" : "";
          listItem.textContent = `${crown} ${index + 1}. ${pos.name} ${crown}: ${formattedBonus} bonus meters`;
          leaderboardList.appendChild(listItem);

          new google.maps.Marker({
            position: new google.maps.LatLng(pos.lat, pos.lng),
            map: map,
            title: `${pos.name}: ${formattedBonus} bonus meters`,
            icon: {
              url: pos.img,
              scaledSize: new google.maps.Size(64, 64),
              origin: new google.maps.Point(0, 0),
              anchor: new google.maps.Point(32, 64)
            },
            label: {
              text: `${pos.name}\n${formattedBonus}`,
              fontSize: "12px",
              fontWeight: "bold",
              color: "#000"
            }
          });
        });
      }
    };
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA23ORAayerNpeDh8WhQkwsv0ZNAon41FI&callback=initMap&libraries=geometry"></script>
</body>
</html>

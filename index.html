<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Animated Face Marker on Google Maps</title>
  <style>
    /* Map and leaderboard styling */
    #map { height: 100vh; width: 100%; }
    #leaderboard {
      position: absolute; top: 10px; right: 10px;
      background: #fff; padding: 16px; border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1002; font-family: Arial, sans-serif;
      font-size: 16px; max-height: 90vh; overflow-y: auto;
      line-height: 1.6; min-width: 220px;
    }
  </style>
  <script>
    // === CONFIGURATION ===
    // Replace 'YOUR_API_KEY' with a valid Google Maps JavaScript API key.
    const API_KEY = 'AIzaSyA23ORAayerNpeDh8WhQkwsv0ZNAon41FI';

    // Error handling for missing or invalid API key
    window.gm_authFailure = function() {
      console.error('Google Maps API authentication failed. Please check your API key and its referrer restrictions.');
      alert('Error: Invalid Google Maps API key. Please update the API_KEY in your code.');
    };

    if (API_KEY === 'YOUR_API_KEY') {
      console.warn('Google Maps API key is not set. Replace \"YOUR_API_KEY\" with a valid key to load the map.');
    }
  </script>
</head>
<body>
  <div id="leaderboard"><strong>Leaderboard</strong><ul id="leaderboard-list"></ul></div>
  <div id="map"></div>

  <script>
    // Constants
    const HQ = { lat: 50.43135, lng: -3.797092, icon: 'img/JHB Logo.png' };
    const WAYPOINTS = [
      'London, UK','Paris, France','Brussels, Belgium','Amsterdam, Netherlands',
      'Berlin, Germany','Prague, Czech Republic','Vienna, Austria',
      'Bratislava, Slovakia','Budapest, Hungary'
    ];
    const DESTINATION = 'Zagreb, Croatia';
    const PEOPLE = [
      'Adrian Lutic','Alex Nita','Antun Vidakovic','Bradley Tunstill','Brendon Kilcullen',
      'Byron Claridge','Callum Evans','Cameron Gill','Christopher Scourfield','Craig Dolan',
      'Darren Hatfield','David Mahon','Edward Shanley','Gary Mounce','George Norris',
      'James Hickman','James Hodge-Brooks','James Rundle-Jones','Jay Dunn','Joe Lambourne-Gillen',
      'John Peters','Jonathan Thompson','Joseph Nixon','Joseph Young','Joshua Powell',
      'Joshua Rowberry','Lewis Cannon','Liam Hammon','Luke Piller','Mark Sneap',
      'Morgan Hemming','Nicholas Kingshott','Richard Clanford','Richard Turvey',
      'Robert Tamas','Ross Watson','Ryan Breslan','Ryan Manners','Tom Brooks','Tyler Webb'
    ];

    function loadMap() {
      if (API_KEY === 'YOUR_API_KEY') return;
      new google.maps.DirectionsService().route({
        origin: HQ,
        destination: DESTINATION,
        waypoints: WAYPOINTS.map(loc => ({ location: loc })),
        travelMode: 'DRIVING'
      }, (res, status) => {
        if (status !== 'OK') {
          console.error('Directions error:', status);
          return;
        }
        initMap(res.routes[0].overview_path);
      });
    }

    function initMap(path) {
      const map = new google.maps.Map(document.getElementById('map'));
      const bounds = new google.maps.LatLngBounds();

      // Compute segment lengths
      const segmentLengths = path.slice(0, -1).map((pt, i) =>
        google.maps.geometry.spherical.computeDistanceBetween(path[i], path[i+1])
      );
      const totalRoute = segmentLengths.reduce((sum, d) => sum + d, 0);

      // Place HQ marker
      new google.maps.Marker({
        map,
        position: HQ,
        icon: {
          url: HQ.icon,
          scaledSize: new google.maps.Size(115, 64),
          anchor: new google.maps.Point(80, 64)
        },
        title: 'JHB UK Ltd',
        zIndex: 999
      });
      bounds.extend(new google.maps.LatLng(HQ.lat, HQ.lng));

      // Create participants
      const participants = PEOPLE.map(name => {
        const bonus = Math.min(Math.floor(Math.random() * 40000), totalRoute);
        const marker = new google.maps.Marker({
          map,
          position: HQ,
          icon: {
            url: `img/${encodeURIComponent(name)}.png`,
            scaledSize: new google.maps.Size(32, 32),
            anchor: new google.maps.Point(16, 32)
          },
          title: name
        });
        return { name, bonus, marker };
      });

      // Compute final positions
      participants.forEach(p => {
        p.finalPos = computePosition(path, segmentLengths, p.bonus);
      });

      // Offset overlapping positions
      participants.forEach((p, i) => {
        for (let j = 0; j < i; j++) {
          const a = p.finalPos, b = participants[j].finalPos;
          const dx = a.lng - b.lng, dy = a.lat - b.lat;
          if (Math.hypot(dx, dy) < 0.0003) {
            a.lat += 0.0003;
            a.lng += 0.0003;
          }
        }
      });

      // Fit bounds
      participants.forEach(p => {
        bounds.extend(new google.maps.LatLng(p.finalPos.lat, p.finalPos.lng));
      });
      map.fitBounds(bounds);

      // Update leaderboard
      participants.sort((a, b) => b.bonus - a.bonus);
      const lb = document.getElementById('leaderboard-list');
      lb.innerHTML = '';
      participants.forEach((p, i) => {
        const li = document.createElement('li');
        li.textContent = `${i === 0 ? 'ðŸ‘‘ ' : ''}${i + 1}. ${p.name}: ${Math.round(p.bonus).toLocaleString()} m`;
        lb.appendChild(li);
      });

      // Animate markers
      participants.forEach(p => {
        animateMarker(p.marker, HQ, p.finalPos, (p.bonus / totalRoute) * 5000);
      });
    }

    function computePosition(path, segs, dist) {
      let traveled = 0, idx = 0;
      while (idx < segs.length && traveled + segs[idx] < dist) {
        traveled += segs[idx++];
      }
      const frac = (dist - traveled) / segs[idx];
      const s = path[idx], e = path[idx + 1];
      return {
        lat: s.lat() + (e.lat() - s.lat()) * frac,
        lng: s.lng() + (e.lng() - s.lng()) * frac
      };
    }

    function animateMarker(marker, startPos, endPos, duration) {
      const startTime = performance.now();
      function step(now) {
        const t = Math.min((now - startTime) / duration, 1);
        const lat = startPos.lat + (endPos.lat - startPos.lat) * t;
        const lng = startPos.lng + (endPos.lng - startPos.lng) * t;
        marker.setPosition({ lat, lng });
        if (t < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // Load Google Maps API script dynamically
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=loadMap&libraries=geometry`;
    script.async = true;
    document.head.appendChild(script);
  </script>
</body>
</html>

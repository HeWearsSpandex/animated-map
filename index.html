<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Animated Face Marker on Google Maps</title>
  <style>
    #map { height:100vh; width:100%; }
    #leaderboard {
      position:absolute; top:10px; right:10px;
      background:#fff; padding:16px; border-radius:10px;
      box-shadow:0 4px 10px rgba(0,0,0,0.3); z-index:1002;
      font-family:Arial,sans-serif; font-size:16px;
      max-height:90vh; overflow-y:auto; min-width:240px;
    }
    #leaderboard-list li {
      display:flex; align-items:center; margin-bottom:8px;
    }
    #leaderboard-list img {
      width:24px; height:24px; border-radius:50%;
      margin-right:8px;
    }
  </style>
</head>
<body>
  <div id="leaderboard">
    <strong>Leaderboard</strong>
    <ul id="leaderboard-list"></ul>
  </div>
  <div id="map"></div>

  <script>
    const API_KEY = 'AIzaSyA23ORAayerNpeDh8WhQkwsv0ZNAon41FI';
    const HQ = { lat:50.43135, lng:-3.797092 };
    const HQ_ICON = 'img/JHB Logo.png';
    const WAYPOINTS = [
      'London, UK','Paris, France','Brussels, Belgium','Amsterdam, Netherlands',
      'Berlin, Germany','Prague, Czech Republic','Vienna, Austria',
      'Bratislava, Slovakia','Budapest, Hungary'
    ];
    const DESTINATION = 'Zagreb, Croatia';
    const PEOPLE = [
      'Adrian Lutic','Alex Nita','Antun Vidakovic','Bradley Tunstill','Brendon Kilcullen',
      'Byron Claridge','Callum Evans','Cameron Gill','Christopher Scourfield','Craig Dolan',
      'Darren Hatfield','David Mahon','Edward Shanley','Gary Mounce','George Norris',
      'James Hickman','James Hodge-Brooks','James Rundle-Jones','Jay Dunn',
      'Joe Lambourne-Gillen','John Peters','Jonathan Thompson','Joseph Nixon',
      'Joseph Young','Joshua Powell','Joshua Rowberry','Lewis Cannon','Liam Hammon',
      'Luke Piller','Mark Sneap','Morgan Hemming','Nicholas Kingshott','Richard Clanford',
      'Richard Turvey','Robert Tamas','Ross Watson','Ryan Breslan','Ryan Manners',
      'Tom Brooks','Tyler Webb'
    ];

    // Helper: composite face+circle into a data-URL
    function compositeIcon(faceUrl, circleUrl, size=64) {
      return new Promise(resolve => {
        const c = document.createElement('canvas');
        c.width = c.height = size;
        const ctx = c.getContext('2d');
        const circle = new Image();
        const face   = new Image();
        circle.onload = () => {
          ctx.drawImage(circle, 0, 0, size, size);
          face.src = faceUrl;
        };
        face.onload = () => {
          ctx.drawImage(face, 0, 0, size, size);
          resolve(c.toDataURL());
        };
        circle.src = circleUrl;
      });
    }

    function loadMap() {
      const svc = new google.maps.DirectionsService();
      svc.route({
        origin: HQ,
        destination: DESTINATION,
        waypoints: WAYPOINTS.map(loc => ({ location: loc })),
        travelMode: 'DRIVING'
      }, (res, status) => {
        if (status !== 'OK') return console.error('Directions error:', status);
        initMap(res.routes[0].overview_path);
      });
    }

    async function initMap(path) {
      const map = new google.maps.Map(document.getElementById('map'));
      const bounds = new google.maps.LatLngBounds();

      // HQ marker
      new google.maps.Marker({
        position: HQ,
        map,
        icon: { url: HQ_ICON, scaledSize: new google.maps.Size(32,32) },
        title: 'JHB UK Ltd'
      });
      bounds.extend(HQ);

      // compute distances
      const segments = path.slice(0,-1).map((_,i) =>
        google.maps.geometry.spherical.computeDistanceBetween(path[i], path[i+1])
      );
      const cum = [0];
      segments.forEach((d,i) => cum[i+1] = cum[i] + d);

      // participants
      const participants = PEOPLE.map(name => {
        const bonus = Math.random() * cum[cum.length-1];
        return {
          name,
          bonus,
          faceUrl: `img/${encodeURIComponent(name)}_cvface1.png`
        };
      });

      // final positions
      participants.forEach(p => {
        let i = cum.findIndex((d, idx) =>
          p.bonus >= d && p.bonus <= cum[idx+1]
        );
        if (i < 0) i = segments.length - 1;
        const A = path[i], B = path[i+1];
        const frac = (p.bonus - cum[i]) / segments[i];
        p.pos = {
          lat: A.lat() + (B.lat()-A.lat()) * frac,
          lng: A.lng() + (B.lng()-A.lng()) * frac
        };
      });

      // offset overlaps
      participants.forEach((p,i) => {
        for (let j=0; j<i; j++) {
          const q = participants[j];
          if (Math.hypot(p.pos.lat-q.pos.lat, p.pos.lng-q.pos.lng) < 0.0005) {
            p.pos.lat += 0.0004;
            p.pos.lng += 0.0004;
          }
        }
      });

      // sort by bonus desc
      participants.sort((a,b) => b.bonus - a.bonus);

      // render leaderboard
      const lb = document.getElementById('leaderboard-list');
      lb.innerHTML = '';
      for (let idx = 0; idx < participants.length; idx++) {
        const p = participants[idx];
        const li = document.createElement('li');
        if (idx === 0) {
          // leader: 24px composite
          const icon24 = await compositeIcon(
            p.faceUrl, 'img/golden_circle.png', 24
          );
          li.innerHTML = `<img src="${icon24}"/><strong>1. ${p.name}: ${Math.round(p.bonus)} m</strong>`;
        } else {
          li.innerHTML = `<img src="${p.faceUrl}"/><span>${idx+1}. ${p.name}: ${Math.round(p.bonus)} m</span>`;
        }
        lb.appendChild(li);
      }

      // place markers
      for (let idx = 0; idx < participants.length; idx++) {
        const p = participants[idx];
        let url;
        if (idx === 0) {
          // leader: 64px composite
          url = await compositeIcon(
            p.faceUrl, 'img/golden_circle.png', 64
          );
        } else {
          url = p.faceUrl;
        }
        new google.maps.Marker({
          position: p.pos,
          map,
          icon: { url, scaledSize: new google.maps.Size(64,64) },
          title: p.name
        });
        bounds.extend(p.pos);
      }

      map.fitBounds(bounds);
    }

    // async-load Google Maps
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=loadMap&libraries=geometry`;
    script.async = true;
    document.head.appendChild(script);
  </script>
</body>
</html>

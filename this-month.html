<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>This Month’s Leaderboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; }
    table { border-collapse: collapse; width:100%; max-width:700px; margin:auto; }
    th, td { padding:8px 12px; text-align:left; }
    th { background:#f4f4f4; }
    img.face { border-radius:50%; vertical-align:middle; }
    td.change img { vertical-align:middle; }
  </style>
</head>
<body>
  <h1>This Month’s Leaderboard</h1>
  <table id="tm-table">
    <thead>
      <tr><th>Face</th><th>Name</th><th>Meters</th><th>Change</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const CSV_URL  = 'https://raw.githubusercontent.com/HeWearsSpandex/animated-map/main/data/actual_distances.csv';
    const IMG_PATH = 'img/';

    async function fetchData() {
      const res = await fetch(CSV_URL, { cache: 'no-cache' });
      if (!res.ok) throw new Error('Could not load CSV: ' + res.status);
      const text = await res.text();
      const [headerLine, ...lines] = text.trim().split(/\r?\n/);
      const headers = headerLine.split(',').map(h => h.trim());
      return lines.map(line => {
        const cols = line.split(',');
        return headers.reduce((obj, h, i) => {
          obj[h] = (cols[i]||'').trim();
          return obj;
        }, {});
      });
    }

    const NAME_OVERRIDES = { 'Bradley Turnstill': 'Bradley_Tunstill' };

    function loadImageElement(src, faceSize) {
      return new Promise(resolve => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = () => {
          console.warn('Could not load face:', src);
          const c = document.createElement('canvas');
          c.width = c.height = faceSize;
          c.getContext('2d').fillStyle = '#ccc';
          c.getContext('2d').fillRect(0,0,faceSize,faceSize);
          resolve(c);
        };
        img.src = src;
      });
    }

    async function drawIcon(name, faceSize = 64, halo = 10) {
      const key      = NAME_OVERRIDES[name] || name;
      const safeName = key.trim().replace(/\s+/g, '_');
      const filename = `${encodeURIComponent(safeName)}_cvface1.png`;
      const src      = `${IMG_PATH}${filename}`;

      const totalSize = faceSize + 2 * halo;
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = totalSize;
      const ctx = canvas.getContext('2d');

      // golden ring
      ctx.fillStyle = 'gold';
      ctx.beginPath();
      ctx.arc(totalSize/2, totalSize/2, faceSize/2 + halo, 0, 2*Math.PI);
      ctx.arc(totalSize/2, totalSize/2, faceSize/2, 0, 2*Math.PI);
      ctx.fill('evenodd');

      // face
      const faceImg = await loadImageElement(src, faceSize);
      ctx.drawImage(faceImg, halo, halo, faceSize, faceSize);

      return canvas.toDataURL('image/png');
    }

    async function buildThisMonthTable() {
      const data = await fetchData();
      const lastRanks = {};
      data.forEach(r => {
        if (r['L/M RANK']) lastRanks[r['NAME']] = Number(r['L/M RANK']);
      });

      const rows = data
        .filter(r => r['T/M RANK'])
        .sort((a,b) => Number(a['T/M RANK']) - Number(b['T/M RANK']));

      const tbody = document.querySelector('#tm-table tbody');
      tbody.innerHTML = '';

      for (let i = 0; i < rows.length; i++) {
        const row    = rows[i];
        const name   = row['NAME'];
        const meters = Math.round(Number(row['TOTAL METERS']) || 0) + ' m';
        const tmRank = Number(row['T/M RANK']);
        const lmRank = lastRanks[name] ?? Infinity;

        // determine arrow image or none
        let changeImg = '';
        if (tmRank < lmRank) changeImg = 'green arrow.png';
        else if (tmRank > lmRank) changeImg = 'red arrow.png';

        // compute display size (face + halo on top rank)
        const baseSize = 64;
        const halo     = (i === 0 ? 10 : 0);
        const displaySize = baseSize + 2 * halo;

        const tr = document.createElement('tr');

        // Face cell
        const tdFace = document.createElement('td');
        const iconUrl = await drawIcon(name, baseSize, halo);
        const faceImgEl = document.createElement('img');
        faceImgEl.src = iconUrl;
        faceImgEl.width = faceImgEl.height = displaySize;
        faceImgEl.classList.add('face');
        tdFace.appendChild(faceImgEl);
        tr.appendChild(tdFace);

        // Name
        const tdName = document.createElement('td');
        tdName.textContent = name;
        tr.appendChild(tdName);

        // Meters
        const tdMet = document.createElement('td');
        tdMet.textContent = meters;
        tr.appendChild(tdMet);

        // Change
        const tdCh = document.createElement('td');
        tdCh.classList.add('change');
        if (changeImg) {
          const arr = new Image();
          arr.src = `${IMG_PATH}${encodeURIComponent(changeImg)}`;
          arr.width = arr.height = displaySize;
          arr.alt = changeImg.includes('green') ? 'Up' : 'Down';
          tdCh.appendChild(arr);
        }
        tr.appendChild(tdCh);

        tbody.appendChild(tr);
      }
    }

    buildThisMonthTable().catch(err => {
      console.error(err);
      document.querySelector('#tm-table tbody').innerHTML =
        '<tr><td colspan="4" style="color:red">Failed to load data.</td></tr>';
    });
  </script>
</body>
</html>
